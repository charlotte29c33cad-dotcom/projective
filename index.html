<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VK Mini App Game</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <div id="score">–°—á—ë—Ç: 0</div>
            <div id="debug-panel" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; z-index: 1000; display: none;">
                <div>localStorage: <span id="ls-status">?</span></div>
                <div>Last save: <span id="last-save">never</span></div>
                <div>Level: <span id="debug-level">?</span></div>
                <button onclick="saveProgress()" style="margin-top: 5px; padding: 5px 10px;">üíæ Save Now</button>
                <button onclick="location.reload()" style="margin-top: 5px; padding: 5px 10px;">üîÑ Reload</button>
                <button onclick="clearProgress()" style="margin-top: 5px; padding: 5px 10px;">üóëÔ∏è Clear</button>
            </div>
        </div>
    </div>

    <!-- VK Bridge SDK -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Game Scripts -->
    <script>
    // Version polling: checks version.json and reloads game.js when version changes
    (function(){
        const POLL_INTERVAL = 10000;
        let currentVersion = null;
        async function checkVersion(){
            try{
                const r = await fetch('version.json', { cache: 'no-cache' });
                if(!r.ok) return;
                const j = await r.json();
                if(!currentVersion){ currentVersion = j.version; return; }
                if(j.version !== currentVersion){
                    console.log('New version detected', j.version);
                    currentVersion = j.version;
                    if(window.Game && typeof window.Game.stop === 'function'){
                        try{ window.Game.stop(); }catch(e){console.warn(e)}
                    }
                    const s = document.createElement('script');
                    s.src = 'game.js?v=' + encodeURIComponent(j.version);
                    s.onload = function(){
                        console.log('New game.js loaded');
                        if(window.Game && typeof window.Game.start === 'function'){
                            window.Game.start();
                        } else {
                            location.reload();
                        }
                    };
                    document.body.appendChild(s);
                }
            }catch(e){ console.warn('version check failed', e); }
        }
        setInterval(checkVersion, POLL_INTERVAL);
        checkVersion();
    })();
    </script>
    <script src="game.js"></script>
</body>
</html>
